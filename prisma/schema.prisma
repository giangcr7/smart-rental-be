// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum RoomStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
}

enum ContractStatus {
  ACTIVE
  EXPIRED
  TERMINATED
}

enum InvoiceStatus {
  UNPAID
  PAID
  OVERDUE
}

enum Role {
  ADMIN
  TENANT
}

// Enum phương thức ra vào (Cho AI/IoT)
enum AccessMethod {
  FACE_ID
  FINGERPRINT
  CARD
  PASSWORD
}

// --- MODELS ---

model Branch {
  id        Int      @id @default(autoincrement())
  name      String
  address   String
  manager   String
  
  image     String?  // Ảnh cổng/toàn cảnh
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  rooms     Room[]
  devices   Device[] // <--- MỚI: Danh sách thiết bị (Cam/Vân tay) tại chi nhánh này
}

// <--- MỚI: Bảng quản lý thiết bị IoT
model Device {
  id        String   @id // ID phần cứng (VD: "ESP32_GATE_01")
  name      String   // Tên thiết bị (VD: "Cổng chính Cầu Giấy")
  branchId  Int
  isActive  Boolean  @default(true)
  
  branch    Branch   @relation(fields: [branchId], references: [id])
  logs      AccessLog[] // Lịch sử ra vào tại thiết bị này
}

model Room {
  id          Int        @id @default(autoincrement())
  roomNumber  String
  price       Decimal    @db.Decimal(10, 2)
  area        Float?
  status      RoomStatus @default(AVAILABLE)
  
  image       String?    // Ảnh phòng
  
  branchId    Int
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  branch    Branch     @relation(fields: [branchId], references: [id])
  contracts Contract[]
  invoices  Invoice[]
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique 
  password      String   
  fullName      String
  phone         String?  
  identityCard  String?  @unique 
  role          Role     @default(TENANT)
  
  avatar        String?  // Avatar
  
  // --- DATA CHO AI & IOT ---
  faceDescriptor Float[] // Vector khuôn mặt (128 chiều)
  fingerprintId  Int?     @unique // ID vân tay (lưu trên AS608)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  contracts     Contract[]
  accessLogs    AccessLog[] // <--- MỚI: Lịch sử ra vào của user này
}

// <--- MỚI: Bảng lịch sử ra vào (Quan trọng để chấm công/an ninh)
model AccessLog {
  id          Int          @id @default(autoincrement())
  checkInAt   DateTime     @default(now())
  method      AccessMethod @default(FINGERPRINT)
  
  // Thông tin thêm (VD: Độ chính xác AI là 98%)
  note        String?      
  
  userId      Int
  deviceId    String?      // Vào từ cổng nào?

  user        User         @relation(fields: [userId], references: [id])
  device      Device?      @relation(fields: [deviceId], references: [id])
}

model Contract {
  id        Int            @id @default(autoincrement())
  startDate DateTime
  endDate   DateTime
  deposit   Decimal        @db.Decimal(10, 2)
  status    ContractStatus @default(ACTIVE)
  
  scanImage String?        // Ảnh hợp đồng giấy
  
  userId    Int
  roomId    Int
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  deletedAt DateTime?

  user      User           @relation(fields: [userId], references: [id])
  room      Room           @relation(fields: [roomId], references: [id])
}

model Invoice {
  id             Int           @id @default(autoincrement())
  month          Int
  year           Int
  
  oldElectricity Int
  newElectricity Int
  oldWater       Int
  newWater       Int
  
  serviceFee     Decimal       @db.Decimal(10, 2) @default(0)
  totalAmount    Decimal       @db.Decimal(10, 2)
  status         InvoiceStatus @default(UNPAID)
  
  paymentProof   String?       // Ảnh chuyển khoản
  
  roomId         Int
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?

  room           Room          @relation(fields: [roomId], references: [id])
}